<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple To-Do List</title>
    <style>
        /* CSS Reset and Base Styles */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary-color: #4a90e2;
            --danger-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --border-color: #dfe6e9;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2rem;
            font-weight: 600;
            margin: 0;
        }

        .input-section {
            padding: 30px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .task-list-section {
            padding: 0;
        }

        .task-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        /* Warning Banner */
        .warning-banner {
            background: var(--warning-color);
            color: white;
            padding: 12px 20px;
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .warning-banner button {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 8px;
        }

        .warning-banner button:hover {
            opacity: 0.8;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 30px;
            color: var(--text-secondary);
        }

        .empty-state p {
            font-size: 1.1rem;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Simple To-Do List</h1>
        </header>
        
        <section class="input-section">
            <!-- Task input form will be added here -->
        </section>
        
        <section class="task-list-section">
            <ul id="taskList" class="task-list">
                <!-- Tasks will be rendered here -->
            </ul>
        </section>
    </div>
    
    <script>
        // ===== STATE MANAGEMENT =====
        let tasks = [];
        const STORAGE_KEY = 'todoApp.tasks';

        // ===== UTILITY FUNCTIONS =====
        
        /**
         * Generate unique task ID using crypto.randomUUID() with fallback
         */
        function generateTaskId() {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            // Fallback UUID v4 generator
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        /**
         * Validate task text (non-empty, ≤500 chars)
         */
        function validateTaskText(text) {
            if (!text || text.trim().length === 0) {
                return { valid: false, error: 'Task cannot be empty' };
            }
            if (text.length > 500) {
                return { valid: false, error: 'Task cannot exceed 500 characters' };
            }
            return { valid: true };
        }

        /**
         * Sanitize task data loaded from storage
         */
        function sanitizeTaskData(loadedTasks) {
            if (!Array.isArray(loadedTasks)) {
                return [];
            }

            // Filter out invalid tasks
            let validTasks = loadedTasks.filter(task =>
                task.id &&
                task.text &&
                task.text.length > 0 &&
                task.text.length <= 500 &&
                typeof task.completed === 'boolean' &&
                typeof task.order === 'number'
            );

            // Ensure unique IDs
            const seenIds = new Set();
            validTasks = validTasks.filter(task => {
                if (seenIds.has(task.id)) return false;
                seenIds.add(task.id);
                return true;
            });

            // Fix order values (make sequential)
            validTasks.sort((a, b) => a.order - b.order);
            validTasks.forEach((task, index) => {
                task.order = index + 1;
            });

            // Fix timestamps if invalid
            validTasks.forEach(task => {
                if (!task.createdAt || typeof task.createdAt !== 'number') {
                    task.createdAt = Date.now();
                }
                if (!task.updatedAt || typeof task.updatedAt !== 'number' || task.updatedAt < task.createdAt) {
                    task.updatedAt = task.createdAt;
                }
            });

            return validTasks;
        }

        /**
         * Display warning banner to user
         */
        function showWarning(message) {
            const existingBanner = document.querySelector('.warning-banner');
            if (existingBanner) {
                existingBanner.remove();
            }

            const banner = document.createElement('div');
            banner.className = 'warning-banner';
            banner.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" aria-label="Dismiss warning">×</button>
            `;

            const container = document.querySelector('.container');
            container.insertBefore(banner, container.firstChild);
        }

        // ===== STORAGE FUNCTIONS =====

        /**
         * Load tasks from LocalStorage
         */
        function loadTasksFromStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    const parsed = JSON.parse(stored);
                    tasks = sanitizeTaskData(parsed);
                    tasks.sort((a, b) => a.order - b.order);
                } else {
                    tasks = [];
                }
            } catch (e) {
                console.error('Failed to load tasks:', e);
                showWarning('Tasks could not be loaded. Using in-memory storage. Changes may not persist.');
                tasks = [];
            }
        }

        /**
         * Save tasks to LocalStorage
         */
        function saveTasksToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
                return true;
            } catch (e) {
                console.error('Failed to save tasks:', e);
                if (e.name === 'QuotaExceededError') {
                    showWarning('Storage quota exceeded. Please delete some tasks.');
                } else {
                    showWarning('Tasks could not be saved. Changes may not persist.');
                }
                return false;
            }
        }

        // ===== INITIALIZATION =====
        
        document.addEventListener('DOMContentLoaded', function() {
            loadTasksFromStorage();
            renderTaskList();
            console.log('To-Do App initialized with', tasks.length, 'tasks');
        });

        /**
         * Render task list (placeholder - will be implemented in US1)
         */
        function renderTaskList() {
            const taskList = document.getElementById('taskList');
            
            if (tasks.length === 0) {
                taskList.innerHTML = '<li class="empty-state"><p>No tasks yet. Add one above!</p></li>';
            } else {
                // Task rendering will be implemented in Phase 3
                taskList.innerHTML = '<li class="empty-state"><p>Task rendering coming soon...</p></li>';
            }
        }
    </script>
</body>
</html>
